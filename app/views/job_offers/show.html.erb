<div class="wrapper-12 teaser">
  <div class="col-sm-12">

    <% if @job_offer.pending? && can?(:accept, @job_offer) %>
      <%= link_to t("job_offers.accept"), accept_job_offer_path(@job_offer), :class => "btn btn-success", data: {confirm: t("job_offers.accept_confirm")} %>
      <%= link_to t("job_offers.decline"), decline_job_offer_path(@job_offer), :class => "btn btn-danger", data: {confirm: t("job_offers.decline_confirm")} %>
    <% end %>

    <% if can? :reopen, @job_offer %>
      <%= link_to t("job_offers.reopen_job"), reopen_job_offer_path(@job_offer), :class => "btn btn-default " %>
    <% end %>

    <span class="pull-right">
      <% if can?(:update, @job_offer) && !@job_offer.completed? %>
        <%= link_to t("job_offers.show_matching_students"), matching_students_path(:language_ids => @job_offer.languages.ids, :programming_language_ids => @job_offer.programming_languages.ids), :class => "btn btn-default", :disabled => !@job_offer.editable? %>
        <% unless @job_offer.running? %>
          <%= link_to t("links.edit"), edit_job_offer_path(@job_offer), :class => "btn btn-default", :disabled => !@job_offer.editable? %>
          <%= link_to t("links.destroy"), job_offer_path(@job_offer), :data => { :confirm => t("links.confirm") }, :method => :delete, :class => "btn btn-danger", :disabled => !@job_offer.editable? %>
        <% end %>
      <% end %>
      <% if can?(:complete, @job_offer) && @job_offer.running? %>
        <%= link_to t("job_offers.job_completed"), complete_job_offer_path(@job_offer), :class => "btn btn-default" %>
      <% end %>
    </span>

    <br><br>

    <% if current_user.applied?(@job_offer) and !flash[:success] %>
      <br><br>
        <div class="panel panel-default panel-body">
        <div class="row">
          <div class="col-sm-10">
            <%= t("job_offers.already_applied") %>
          </div>
          <div class="col-sm-2">
            <% unless @application.blank? %>
              <%= simple_form_for @application, method: :delete do |f| %>
                  <div><%= f.input :id, as: :hidden %></div>
                  <%= f.submit t("applications.delete"), class: 'btn btn-danger apply-button pull-right', data: { confirm: t("applications.delete_confirmation") } %>
              <% end %>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>

    <br>
    <div class="row">
      <div class="col-sm-12">
        <h1 style="display:inline">
          <%= @job_offer.title %>
            <% if @job_offer.pending? %>
              <span> - <%= t("job_status.pending") %></span>
          <% end %>
        </h1>
        <blockquote>
            <p><%= @job_offer.employer.name %></p>
        </blockquote>
      </div>
    </div>

    <div class="panel panel-default">
      <div class="panel-heading"><h4><%= t("activerecord.attributes.job_offer.description") %></h4></div>
      <ul class="list-group">
        <li class="list-group-item">
          <div class="row">
            <div class="col-sm-12">
              <%= sanitize_html(@job_offer.description.html_safe) %>
            </div>
          </div>
        </li>
      </ul>
    </div>

    <div class="row">
      <div class="col-sm-6">

        <div class="panel panel-default">
          <div class="panel-heading"><h4><%= t("activerecord.attributes.job_offer.additional_information") %></h4></div>
          <ul class="list-group">
            <% unless @job_offer.room_number.blank? %>
              <%= render 'job_offers/list_group_item', title: t("activerecord.attributes.job_offer.room_number"), content: @job_offer.room_number %>
            <% end %>
            <%= render 'job_offers/list_group_item', title: t("activerecord.attributes.job_offer.start_date"), content: l(@job_offer.start_date) %>
            <% unless @job_offer.end_date.blank? %>
              <li class="list-group-item">
                <div class="row">
                  <div class="col-sm-3">
                    <%= t("activerecord.attributes.job_offer.end_date") %>
                  </div>
                  <div class="col-sm-9">
                    <%= l(@job_offer.end_date) %>
                    <% if can? :prolong, @job_offer%>
                      <%= simple_form_for [:prolong, @job_offer], method: :put, html: { id: 'prolong-form' } do |f| %>
                        <%= f.text_field :end_date, class: 'datepicker form-control' %>
                        <%= f.submit t("job_offers.prolong"), class: 'btn btn-info' %>
                      <% end %>
                    <% end %>
                  </div>
                </div>
              </li>
            <% end %>
            <%= render 'job_offers/list_group_item', title: t("activerecord.attributes.job_offer.time_effort"), content: (@job_offer.time_effort.to_s  + " " + t("job_offers.time_effort_description")) %>
            <%= render 'job_offers/list_group_item', title: t("activerecord.attributes.job_offer.compensation"), content: @job_offer.human_readable_compensation %>
            <% unless @job_offer.responsible_user.blank? %>
              <%= render 'job_offers/list_group_item', title: t("activerecord.attributes.job_offer.contact"), content: (link_to @job_offer.responsible_user.full_name, @job_offer.responsible_user) %>
            <% end %>
            <%= render 'job_offers/list_group_item', title: t("activerecord.attributes.job_offer.vacant_posts"), content: @job_offer.vacant_posts %>
          </ul>
        </div>
      </div>

      <% unless @job_offer.programming_languages.blank? %>
        <%= render 'job_offers/language_list', title: t("job_offers.required_programming_languages"), languages: @job_offer.programming_languages %>
      <% end %>

      <% unless @job_offer.languages.blank? %>
        <%= render 'job_offers/language_list', title: t("job_offers.required_languages"), languages: @job_offer.languages %>
      <% end %>

      <% if (user_is_staff_of_employer?(@job_offer) or current_user.admin?) && !@assigned_students.blank? %>
        <div class="col-sm-6">
          <div class="panel panel-default">
            <div class="panel-heading"><h4><%= t("job_offers.students") %></h4></div>
              <%= render 'shared/user_list', user_list: @assigned_students, show_fire_button: can?(:fire, @job_offer) %>
          </div>
        </div>
      <%end%>
    </div>

    <div class="row">
      <div class="pull-right">
        <% if !current_user.applied?(@job_offer) && can?(:create, Application.new) && @job_offer.open? %>
          <%= submit_tag t("job_offers.apply"), class: 'btn btn-default apply-button', data: {toggle: "modal", target: "#applicationEmailModal" } %>
          <!-- Modal for sending an application email-->
          <div class="modal fade" id="applicationEmailModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                  <h4 class="modal-title" id="myModalLabel"><%= t "job_offers.send_application_headline" %></h4>
                </div>
                <%= simple_form_for current_user.applications.build(job_offer_id: @job_offer.id), html: { multipart: true } do |f| %>
                  <div class="modal-body clearfix">
                    <%= f.input :job_offer_id, as: :hidden %>
                    <%= text_area_tag :message, t("applications_mailer.students.apply.application"), as: :bootsy, rows: 10, class: "col-md-12 form-control"  %>
                    <% unless (current_user.cv.path).nil? %>
                      <br/>
                      <%= check_box_tag :add_cv, nil, true %>
                      <%= label_tag :add_cv, t("job_offers.add_cv_application") %>
                      <small style="margin-left:10px;"><%= File.basename(current_user.cv.path) %></small>
                    <% end %>
                    <%= file_field_tag 'attached_files', multiple: true, name: "attached_files[file_attributes][][file]" %>
                  </div>
                  <div class="modal-footer">
                    <span class="btn btn-default", data-dismiss="modal"><%= t("links.cancel") %></span>
                    <%= f.submit t("job_offers.send_application"), class: 'btn btn-success apply-button' %>
                  </div>
                <% end %>
              </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
          </div><!-- /.modal -->
        <% end %>
      </div>


    </div>

    <% if @job_offer.applications.any? && !@job_offer.completed? && can?(:read, @job_offer.applications.first) %>
      <div class="clearfix">
        <div class="panel panel-default">
          <div class="panel-heading"><h4><%= t("job_offers.applications_headline")%></h4></div>
          <table class="table table-hover">
            <thead>
              <tr>
                <th><%= t("job_offers.applicant_first_name") %></th>
                <th><%= t("job_offers.applicant_last_name") %></th>
                <th><%= t("job_offers.applicant_email") %></th>
              </tr>
            </thead>
            <tbody>
              <%= render @job_offer.applications %>
            </tbody>
          </table>
        </div>
      </div>
    <% end %>

  </div>
</div>
